<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>[MySQL案例]之in与range查询 | HiDBA | 林晓嘉</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="首先我们来说下in()这种方式的查询。在《高性能MySQL》里面提及用in这种方式可以有效的替代一定的range查询，提升查询效率，因为在一条索引里面，range字段后面的部分是不生效的。使用in这种方式其实MySQL优化器是转化成了n*m种组合方式来进行查询，最终将返回值合并，有点类似union但是更高效。同时它存在这一些问题：

老版本的MySQL在IN()组合条件过多的时候会发生很多问题。查">
<meta property="og:type" content="article">
<meta property="og:title" content="[MySQL案例]之in与range查询">
<meta property="og:url" content="http://myrock.github.io/2014/09/24/[MySQL案例]之in与range查询/">
<meta property="og:site_name" content="HiDBA | 林晓嘉">
<meta property="og:description" content="首先我们来说下in()这种方式的查询。在《高性能MySQL》里面提及用in这种方式可以有效的替代一定的range查询，提升查询效率，因为在一条索引里面，range字段后面的部分是不生效的。使用in这种方式其实MySQL优化器是转化成了n*m种组合方式来进行查询，最终将返回值合并，有点类似union但是更高效。同时它存在这一些问题：

老版本的MySQL在IN()组合条件过多的时候会发生很多问题。查">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[MySQL案例]之in与range查询">
<meta name="twitter:description" content="首先我们来说下in()这种方式的查询。在《高性能MySQL》里面提及用in这种方式可以有效的替代一定的range查询，提升查询效率，因为在一条索引里面，range字段后面的部分是不生效的。使用in这种方式其实MySQL优化器是转化成了n*m种组合方式来进行查询，最终将返回值合并，有点类似union但是更高效。同时它存在这一些问题：

老版本的MySQL在IN()组合条件过多的时候会发生很多问题。查">

  
    <link rel="alternative" href="/atom.xml" title="HiDBA | 林晓嘉" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<div class="profilepic">
			<img src="http://image-myrock-github-io.qiniudn.com/head.jpg">
		</div>

		<hgroup>
		  <h1 class="header-author"><a href="/">林晓嘉</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Technology change our life.</p>
		
		<nav class="header-menu">
			<ul>
			
				<li><a href="/">HOME</a></li>
	        
				<li><a href="/tags/database">DATABASE</a></li>
	        
				<li><a href="/tags/linux">LINUX</a></li>
	        
				<li><a href="/tags/other">Other Technology</a></li>
	        
				<li><a href="/tags/life">LIFE</a></li>
	        
			</ul>
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/myrock/myrock.github.io" title="github">github</a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/u/1735228455" title="weibo">weibo</a>
		        
			</div>
		</nav>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay"></div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="http://image-myrock-github-io.qiniudn.com/head.jpg">
			</div>

			<hgroup>
			  <h1 class="header-author"><a href="/">林晓嘉</a></h1>
			</hgroup>
			
			<p class="header-subtitle">Technology change our life.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">HOME</a></li>
		        
					<li><a href="/tags/database">DATABASE</a></li>
		        
					<li><a href="/tags/linux">LINUX</a></li>
		        
					<li><a href="/tags/other">Other Technology</a></li>
		        
					<li><a href="/tags/life">LIFE</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/myrock/myrock.github.io" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/u/1735228455" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <article id="post-[MySQL案例]之in与range查询" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/09/24/[MySQL案例]之in与range查询/" class="article-date">
  	<time datetime="2014-09-24T07:22:01.000Z" itemprop="datePublished">9月 24 2014</time>
</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/database/">database</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li></ul>

    </div>
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      [MySQL案例]之in与range查询
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>首先我们来说下in()这种方式的查询。在《高性能MySQL》里面提及用in这种方式可以有效的替代一定的range查询，提升查询效率，因为在一条索引里面，range字段后面的部分是不生效的。使用in这种方式其实MySQL优化器是转化成了n*m种组合方式来进行查询，最终将返回值合并，有点类似union但是更高效。同时它存在这一些问题：</p>
<blockquote>
<p>老版本的MySQL在IN()组合条件过多的时候会发生很多问题。查询优化可能需要花很多时间，并消耗大量内存。新版本MySQL在组合数超过一定的数量就不进行计划评估了，这可能导致MySQL不能很好的利用索引。</p>
</blockquote>
<p>因为我也不知道也找不到这里的“一定数量”是多少，因此我一直在跟大家伙说in一定要少，最好少于10个，不要出现两个in，即便出现了乘积必须小于20。说到底我一直认为少量的in()是木有问题的，索引都是可以走的，一直到今天优化了一个SQL。</p>
<a id="more"></a>

<p>SQL如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> pre_forum_post <span class="keyword">WHERE</span> tid=<span class="number">7932552</span> <span class="keyword">AND</span> <span class="string">`invisible`</span> <span class="keyword">IN</span>(<span class="string">'0'</span>,<span class="string">'-2'</span>) </span></div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> dateline <span class="keyword">DESC</span>  <span class="keyword">LIMIT</span> <span class="number">10</span>;</div></pre></td></tr></table></figure>

<p>索引如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">+----------------+------------+--------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</div><div class="line">| <span class="class">Table</span>          | <span class="class">Non_unique</span> | <span class="class">Key_name</span>     | <span class="class">Seq_in_index</span> | <span class="class">Column_name</span> | <span class="class">Collation</span> | <span class="class">Cardinality</span> | <span class="class">Sub_part</span> | <span class="class">Packed</span> | <span class="class">Null</span> | <span class="class">Index_type</span> | <span class="class">Comment</span> | <span class="class">Index_comment</span> |</div><div class="line">+----------------+------------+--------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">0</span> | <span class="class">PRIMARY</span>      |            <span class="number">1</span> <span class="localvars">| tid         |</span> <span class="class">A</span>         |        <span class="class">NULL</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">0</span> | <span class="class">PRIMARY</span>      |            <span class="number">2</span> <span class="localvars">| position    |</span> <span class="class">A</span>         |    <span class="number">25521392</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">0</span> <span class="localvars">| pid          |</span>            <span class="number">1</span> <span class="localvars">| pid         |</span> <span class="class">A</span>         |    <span class="number">25521392</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| fid          |</span>            <span class="number">1</span> <span class="localvars">| fid         |</span> <span class="class">A</span>         |        <span class="number">1490</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| displayorder |</span>            <span class="number">1</span> <span class="localvars">| tid         |</span> <span class="class">A</span>         |      <span class="number">880048</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| displayorder |</span>            <span class="number">2</span> <span class="localvars">| invisible   |</span> <span class="class">A</span>         |      <span class="number">945236</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| displayorder |</span>            <span class="number">3</span> <span class="localvars">| dateline    |</span> <span class="class">A</span>         |    <span class="number">25521392</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| first        |</span>            <span class="number">1</span> <span class="localvars">| tid         |</span> <span class="class">A</span>         |      <span class="number">880048</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| first        |</span>            <span class="number">2</span> <span class="localvars">| first       |</span> <span class="class">A</span>         |     <span class="number">1215304</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| new_auth     |</span>            <span class="number">1</span> <span class="localvars">| authorid    |</span> <span class="class">A</span>         |     <span class="number">1963184</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| new_auth     |</span>            <span class="number">2</span> <span class="localvars">| invisible   |</span> <span class="class">A</span>         |     <span class="number">1963184</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| new_auth     |</span>            <span class="number">3</span> <span class="localvars">| tid         |</span> <span class="class">A</span>         |    <span class="number">12760696</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| idx_dt       |</span>            <span class="number">1</span> <span class="localvars">| dateline    |</span> <span class="class">A</span>         |    <span class="number">25521392</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| mul_test     |</span>            <span class="number">1</span> <span class="localvars">| tid         |</span> <span class="class">A</span>         |      <span class="number">880048</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| mul_test     |</span>            <span class="number">2</span> <span class="localvars">| invisible   |</span> <span class="class">A</span>         |      <span class="number">945236</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| mul_test     |</span>            <span class="number">3</span> <span class="localvars">| dateline    |</span> <span class="class">A</span>         |    <span class="number">25521392</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| mul_test     |</span>            <span class="number">4</span> <span class="localvars">| pid         |</span> <span class="class">A</span>         |    <span class="number">25521392</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line">+----------------+------------+--------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</div></pre></td></tr></table></figure>

<p>看下执行计划：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">root@localhost 16:08:27 [ultrax]&gt; explain SELECT  * FROM pre<span class="emphasis">_forum_</span>post WHERE tid=7932552 AND <span class="smartquote">`invisible` IN('</span>0',<span class="emphasis">'-2'</span>) </div><div class="line"><span class="header">    -&gt; ORDER BY dateline DESC  LIMIT 10;</span></div><div class="line">+----+-------------+----------------+-------+-------------------------------------------+--------------+---------+------+------+---------------------------------------+</div><div class="line"><span class="header">| id | select_type | table          | type  | possible_keys                             | key          | key_len | ref  | rows | Extra                                 |</span></div><div class="line">+----+-------------+----------------+-------+-------------------------------------------+--------------+---------+------+------+---------------------------------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | pre_forum_post | range | PRIMARY,displayorder,first,mul_test,idx_1 | displayorder | 4       | NULL |   54 | Using index condition; Using filesort | </span></div><div class="line">+----+-------------+----------------+-------+-------------------------------------------+--------------+---------+------+------+---------------------------------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>

<p>MySQL优化器认为这是一个range查询，那么(tid,invisible,dateline)这条索引中，dateline字段肯定用不上了，也就是说这个SQL最后的排序肯定会生成一个临时结果集，然后再结果集里面完成排序，而不是直接在索引中直接完成排序动作，于是我尝试增加了一条索引。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">root@localhost <span class="number">16</span>:<span class="number">09</span>:<span class="number">06</span> [ultrax]&gt; alter table pre_forum_post <span class="keyword">add</span> <span class="keyword">index</span> idx_1 (tid,dateline);   </div><div class="line">Query OK, <span class="number">20374596</span> rows affected, <span class="number">0</span> warning (<span class="number">600.23</span> sec)</div><div class="line">Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></div><div class="line"></div><div class="line">root@localhost <span class="number">16</span>:<span class="number">20</span>:<span class="number">22</span> [ultrax]&gt; explain <span class="keyword">SELECT</span>  * <span class="keyword">FROM</span> pre_forum_post force <span class="keyword">index</span> (idx_1) <span class="keyword">WHERE</span> tid=<span class="number">7932552</span> <span class="keyword">AND</span> `invisible` <span class="keyword">IN</span>(<span class="string">'0'</span>,<span class="string">'-2'</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> dateline <span class="keyword">DESC</span>  LIMIT <span class="number">10</span>;</div><div class="line">+----+-------------+----------------+------+---------------+-------+---------+-------+--------+-------------+</div><div class="line">| id | select_type | table          | <span class="keyword">type</span> | possible_keys | key   | key_len | ref   | rows   | Extra       |</div><div class="line">+----+-------------+----------------+------+---------------+-------+---------+-------+--------+-------------+</div><div class="line">|  <span class="number">1</span> | SIMPLE      | pre_forum_post | ref  | idx_1         | idx_1 | <span class="number">3</span>       | <span class="keyword">const</span> | <span class="number">120646</span> | <span class="keyword">Using</span> <span class="keyword">where</span> | </div><div class="line">+----+-------------+----------------+------+---------------+-------+---------+-------+--------+-------------+</div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">root@localhost <span class="number">16</span>:<span class="number">22</span>:<span class="number">06</span> [ultrax]&gt; <span class="keyword">SELECT</span> sql_no_cache * <span class="keyword">FROM</span> pre_forum_post <span class="keyword">WHERE</span> tid=<span class="number">7932552</span> <span class="keyword">AND</span> `invisible` <span class="keyword">IN</span>(<span class="string">'0'</span>,<span class="string">'-2'</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> dateline <span class="keyword">DESC</span>  LIMIT <span class="number">10</span>;</div><div class="line">...</div><div class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.40</span> sec)</div><div class="line"></div><div class="line">root@localhost <span class="number">16</span>:<span class="number">23</span>:<span class="number">55</span> [ultrax]&gt; <span class="keyword">SELECT</span> sql_no_cache * <span class="keyword">FROM</span> pre_forum_post force <span class="keyword">index</span> (idx_1) <span class="keyword">WHERE</span> tid=<span class="number">7932552</span> <span class="keyword">AND</span> `invisible` <span class="keyword">IN</span>(<span class="string">'0'</span>,<span class="string">'-2'</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> dateline <span class="keyword">DESC</span>  LIMIT <span class="number">10</span>;</div><div class="line">...</div><div class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>

<p>实验证明效果是极好的，其实不难理解，上面我们就说了in()在MySQL优化器里面是以多种组合方式来检索数据的，如果加了一个排序或者分组那势必只能在临时结果集上操作，也就是说索引里面即使包含了排序或者分组的字段依然是没用的。唯一不满的是MySQL优化器的选择依然不够靠谱。</p>
<p>最后总结下：在MySQL查询里面使用in()，除了要注意组合乘积以外，还要注意如果SQL包含排序/分组/去重等等就需要注意索引的使用。</p>

      
    </div>
    <footer class="article-footer">
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/09/25/[MySQL案例]之Discuz大表拆分/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          [MySQL案例]之Discuz大表拆分
        
      </div>
    </a>
  
  
    <a href="/2014/09/22/[MySQL案例]之恢复进程莫名被杀/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">[MySQL案例]之恢复进程莫名被杀</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="[MySQL案例]之in与range查询" data-title="[MySQL案例]之in与range查询" data-url="http://myrock.github.io/2014/09/24/[MySQL案例]之in与range查询/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
    		&copy; 2014 林晓嘉
    	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


  </div>
</body>
</html>