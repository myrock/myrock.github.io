<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>[MySQL SQL优化系列]之in与range查询 | HiDBA | 林晓嘉</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="首先我们来说下in()这种方式的查询。在《高性能MySQL》里面提及用in这种方式可以有效的替代一定的range查询，提升查询效率，因为在一条索引里面，range字段后面的部分是不生效的。使用in这种方式其实MySQL优化器是转化成了n*m种组合方式来进行查询，最终将返回值合并，有点类似union但是更高效。同时它存在这一些问题：

老版本的MySQL在IN()组合条件过多的时候会发生很多问题。查">
<meta property="og:type" content="article">
<meta property="og:title" content="[MySQL SQL优化系列]之in与range查询">
<meta property="og:url" content="http://myrock.github.io/2014/09/24/in-and-range/">
<meta property="og:site_name" content="HiDBA | 林晓嘉">
<meta property="og:description" content="首先我们来说下in()这种方式的查询。在《高性能MySQL》里面提及用in这种方式可以有效的替代一定的range查询，提升查询效率，因为在一条索引里面，range字段后面的部分是不生效的。使用in这种方式其实MySQL优化器是转化成了n*m种组合方式来进行查询，最终将返回值合并，有点类似union但是更高效。同时它存在这一些问题：

老版本的MySQL在IN()组合条件过多的时候会发生很多问题。查">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[MySQL SQL优化系列]之in与range查询">
<meta name="twitter:description" content="首先我们来说下in()这种方式的查询。在《高性能MySQL》里面提及用in这种方式可以有效的替代一定的range查询，提升查询效率，因为在一条索引里面，range字段后面的部分是不生效的。使用in这种方式其实MySQL优化器是转化成了n*m种组合方式来进行查询，最终将返回值合并，有点类似union但是更高效。同时它存在这一些问题：

老版本的MySQL在IN()组合条件过多的时候会发生很多问题。查">

  
    <link rel="alternative" href="/atom.xml" title="HiDBA | 林晓嘉" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
  
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F3693cef63e2b72be16ac8ddde570e37d' type='text/javascript'%3E%3C/script%3E"));
</script>

</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<div class="profilepic">
			<img src="http://image-myrock-github-io.qiniudn.com/head.jpg">
		</div>

		<hgroup>
		  <h1 class="header-author"><a href="/">林晓嘉</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Technology change our life.</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">HOME</a></li>
				        
							<li><a href="/archives">ARCHIVES</a></li>
				        
							<li><a href="/aboutme">ABOUT</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/myrock/myrock.github.io" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/u/1735228455" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud">
						<a href="/tags/MySQL/" style="font-size: 20.00px;">MySQL</a><a href="/tags/NoSQL/" style="font-size: 10.00px;">NoSQL</a><a href="/tags/Redis/" style="font-size: 10.00px;">Redis</a><a href="/tags/SQL优化/" style="font-size: 15.00px;">SQL优化</a><a href="/tags/database/" style="font-size: 20.00px;">database</a><a href="/tags/ops/" style="font-size: 10.00px;">ops</a><a href="/tags/other/" style="font-size: 10.00px;">other</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://imysql.com/">叶金荣</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://ljf.me/">李健富</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://17173ops.com/">17173系统部</a>
			        
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					围绕着MySQL、NoSQL、Hadoop、运维开发领域摸爬滚打中的Rockpapa
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay"></div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="http://image-myrock-github-io.qiniudn.com/head.jpg">
			</div>

			<hgroup>
			  <h1 class="header-author"><a href="/">林晓嘉</a></h1>
			</hgroup>
			
			<p class="header-subtitle">Technology change our life.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">HOME</a></li>
		        
					<li><a href="/archives">ARCHIVES</a></li>
		        
					<li><a href="/aboutme">ABOUT</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/myrock/myrock.github.io" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/u/1735228455" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <article id="post-in-and-range" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/09/24/in-and-range/" class="article-date">
  	<time datetime="2014-09-24T07:22:01.000Z" itemprop="datePublished">9月 24 2014</time>
</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SQL优化/">SQL优化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/database/">database</a></li></ul>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      [MySQL SQL优化系列]之in与range查询
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>首先我们来说下in()这种方式的查询。在《高性能MySQL》里面提及用in这种方式可以有效的替代一定的range查询，提升查询效率，因为在一条索引里面，range字段后面的部分是不生效的。使用in这种方式其实MySQL优化器是转化成了n*m种组合方式来进行查询，最终将返回值合并，有点类似union但是更高效。同时它存在这一些问题：</p>
<blockquote>
<p>老版本的MySQL在IN()组合条件过多的时候会发生很多问题。查询优化可能需要花很多时间，并消耗大量内存。新版本MySQL在组合数超过一定的数量就不进行计划评估了，这可能导致MySQL不能很好的利用索引。</p>
</blockquote>
<p>这里的“一定数量”在MySQL5.6.5以及以后的版本中是由eq_range_index_dive_limit这个参数控制（感谢<a href="http://imysql.com" target="_blank" rel="external">@叶金荣</a>同学的指点）。默认设置是10，一直到5.7以后的版本默认会修改成200，当然我们是可以手动设置的。我们看下5.6手册中的说明：</p>
<blockquote>
<p>The eq_range_index_dive_limit system variable enables you to configure the number of values at which the optimizer switches from one row estimation strategy to the other. To disable use of statistics and always use index dives, set eq_range_index_dive_limit to 0. To permit use of index dives for comparisons of up to N equality ranges, set eq_range_index_dive_limit to N + 1.<br>eq_range_index_dive_limit is available as of MySQL 5.6.5. Before 5.6.5, the optimizer uses index dives, which is equivalent to eq_range_index_dive_limit=0.</p>
</blockquote>
<p>也就是说：</p>
<pre><code><span class="number">1</span>. eq_range_index_dive_limit = <span class="number">0</span> 只能使用<span class="built_in">index</span> dive
<span class="number">2</span>. <span class="number">0</span> &lt; eq_range_index_dive_limit &lt;= <span class="keyword">N</span> 使用<span class="built_in">index</span> statistics
<span class="number">3</span>. eq_range_index_dive_limit &gt; <span class="keyword">N</span> 只能使用<span class="built_in">index</span> dive
</code></pre><p>index dive与index statistics是MySQL优化器对开销代价的估算方法，前者统计速度慢但是能得到精准的值，后者统计速度快但是数据未必精准。</p>
<blockquote>
<p>the optimizer can estimate the row count for each range using dives into the index or index statistics.</p>
</blockquote>
<p>在MySQL5.7版本中将默认值从10修改成200目的是为了尽可能的保证范围等值运算（IN()）执行计划尽量精准，因为IN()list的数量很多时候都是超过10的。</p>
<h2 id="说在前面">说在前面</h2>
<p>今天文章的主题有两个：</p>
<ol>
<li>range查询与索引使用</li>
<li>eq_range_index_dive_limit的说明</li>
</ol>
<a id="more"></a>

<h2 id="range查询与索引使用">range查询与索引使用</h2>
<p>SQL如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> pre_forum_post <span class="keyword">WHERE</span> tid=<span class="number">7932552</span> <span class="keyword">AND</span> <span class="string">`invisible`</span> <span class="keyword">IN</span>(<span class="string">'0'</span>,<span class="string">'-2'</span>) </span></div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> dateline <span class="keyword">DESC</span>  <span class="keyword">LIMIT</span> <span class="number">10</span>;</div></pre></td></tr></table></figure>

<p>索引如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">+----------------+------------+--------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</div><div class="line">| <span class="class">Table</span>          | <span class="class">Non_unique</span> | <span class="class">Key_name</span>     | <span class="class">Seq_in_index</span> | <span class="class">Column_name</span> | <span class="class">Collation</span> | <span class="class">Cardinality</span> | <span class="class">Sub_part</span> | <span class="class">Packed</span> | <span class="class">Null</span> | <span class="class">Index_type</span> | <span class="class">Comment</span> | <span class="class">Index_comment</span> |</div><div class="line">+----------------+------------+--------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">0</span> | <span class="class">PRIMARY</span>      |            <span class="number">1</span> <span class="localvars">| tid         |</span> <span class="class">A</span>         |        <span class="class">NULL</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">0</span> | <span class="class">PRIMARY</span>      |            <span class="number">2</span> <span class="localvars">| position    |</span> <span class="class">A</span>         |    <span class="number">25521392</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">0</span> <span class="localvars">| pid          |</span>            <span class="number">1</span> <span class="localvars">| pid         |</span> <span class="class">A</span>         |    <span class="number">25521392</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| fid          |</span>            <span class="number">1</span> <span class="localvars">| fid         |</span> <span class="class">A</span>         |        <span class="number">1490</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| displayorder |</span>            <span class="number">1</span> <span class="localvars">| tid         |</span> <span class="class">A</span>         |      <span class="number">880048</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| displayorder |</span>            <span class="number">2</span> <span class="localvars">| invisible   |</span> <span class="class">A</span>         |      <span class="number">945236</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| displayorder |</span>            <span class="number">3</span> <span class="localvars">| dateline    |</span> <span class="class">A</span>         |    <span class="number">25521392</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| first        |</span>            <span class="number">1</span> <span class="localvars">| tid         |</span> <span class="class">A</span>         |      <span class="number">880048</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| first        |</span>            <span class="number">2</span> <span class="localvars">| first       |</span> <span class="class">A</span>         |     <span class="number">1215304</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| new_auth     |</span>            <span class="number">1</span> <span class="localvars">| authorid    |</span> <span class="class">A</span>         |     <span class="number">1963184</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| new_auth     |</span>            <span class="number">2</span> <span class="localvars">| invisible   |</span> <span class="class">A</span>         |     <span class="number">1963184</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| new_auth     |</span>            <span class="number">3</span> <span class="localvars">| tid         |</span> <span class="class">A</span>         |    <span class="number">12760696</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| idx_dt       |</span>            <span class="number">1</span> <span class="localvars">| dateline    |</span> <span class="class">A</span>         |    <span class="number">25521392</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| mul_test     |</span>            <span class="number">1</span> <span class="localvars">| tid         |</span> <span class="class">A</span>         |      <span class="number">880048</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| mul_test     |</span>            <span class="number">2</span> <span class="localvars">| invisible   |</span> <span class="class">A</span>         |      <span class="number">945236</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| mul_test     |</span>            <span class="number">3</span> <span class="localvars">| dateline    |</span> <span class="class">A</span>         |    <span class="number">25521392</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line"><span class="localvars">| pre_forum_post |</span>          <span class="number">1</span> <span class="localvars">| mul_test     |</span>            <span class="number">4</span> <span class="localvars">| pid         |</span> <span class="class">A</span>         |    <span class="number">25521392</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |               | </div><div class="line">+----------------+------------+--------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</div></pre></td></tr></table></figure>

<p>看下执行计划：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">root@localhost 16:08:27 [ultrax]&gt; explain SELECT  * FROM pre<span class="emphasis">_forum_</span>post WHERE tid=7932552 AND <span class="smartquote">`invisible` IN('</span>0',<span class="emphasis">'-2'</span>) </div><div class="line"><span class="header">    -&gt; ORDER BY dateline DESC  LIMIT 10;</span></div><div class="line">+----+-------------+----------------+-------+-------------------------------------------+--------------+---------+------+------+---------------------------------------+</div><div class="line"><span class="header">| id | select_type | table          | type  | possible_keys                             | key          | key_len | ref  | rows | Extra                                 |</span></div><div class="line">+----+-------------+----------------+-------+-------------------------------------------+--------------+---------+------+------+---------------------------------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | pre_forum_post | range | PRIMARY,displayorder,first,mul_test,idx_1 | displayorder | 4       | NULL |   54 | Using index condition; Using filesort | </span></div><div class="line">+----+-------------+----------------+-------+-------------------------------------------+--------------+---------+------+------+---------------------------------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>

<p>MySQL优化器认为这是一个range查询，那么(tid,invisible,dateline)这条索引中，dateline字段肯定用不上了，也就是说这个SQL最后的排序肯定会生成一个临时结果集，然后再结果集里面完成排序，而不是直接在索引中直接完成排序动作，于是我们尝试增加了一条索引。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">root@localhost <span class="number">16</span>:<span class="number">09</span>:<span class="number">06</span> [ultrax]&gt; alter table pre_forum_post <span class="keyword">add</span> <span class="keyword">index</span> idx_1 (tid,dateline);   </div><div class="line">Query OK, <span class="number">20374596</span> rows affected, <span class="number">0</span> warning (<span class="number">600.23</span> sec)</div><div class="line">Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></div><div class="line"></div><div class="line">root@localhost <span class="number">16</span>:<span class="number">20</span>:<span class="number">22</span> [ultrax]&gt; explain <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> pre_forum_post force <span class="keyword">index</span> (idx_1) <span class="keyword">WHERE</span> tid=<span class="number">7932552</span> <span class="keyword">AND</span> `invisible` <span class="keyword">IN</span>(<span class="string">'0'</span>,<span class="string">'-2'</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> dateline <span class="keyword">DESC</span>  LIMIT <span class="number">10</span>;</div><div class="line">+----+-------------+----------------+------+---------------+-------+---------+-------+--------+-------------+</div><div class="line">| id | select_type | table          | <span class="keyword">type</span> | possible_keys | key   | key_len | ref   | rows   | Extra       |</div><div class="line">+----+-------------+----------------+------+---------------+-------+---------+-------+--------+-------------+</div><div class="line">|  <span class="number">1</span> | SIMPLE      | pre_forum_post | ref  | idx_1         | idx_1 | <span class="number">3</span>       | <span class="keyword">const</span> | <span class="number">120646</span> | <span class="keyword">Using</span> <span class="keyword">where</span> | </div><div class="line">+----+-------------+----------------+------+---------------+-------+---------+-------+--------+-------------+</div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">root@localhost <span class="number">16</span>:<span class="number">22</span>:<span class="number">06</span> [ultrax]&gt; <span class="keyword">SELECT</span> sql_no_cache * <span class="keyword">FROM</span> pre_forum_post <span class="keyword">WHERE</span> tid=<span class="number">7932552</span> <span class="keyword">AND</span> `invisible` <span class="keyword">IN</span>(<span class="string">'0'</span>,<span class="string">'-2'</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> dateline <span class="keyword">DESC</span>  LIMIT <span class="number">10</span>;</div><div class="line">...</div><div class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.40</span> sec)</div><div class="line"></div><div class="line">root@localhost <span class="number">16</span>:<span class="number">23</span>:<span class="number">55</span> [ultrax]&gt; <span class="keyword">SELECT</span> sql_no_cache * <span class="keyword">FROM</span> pre_forum_post force <span class="keyword">index</span> (idx_1) <span class="keyword">WHERE</span> tid=<span class="number">7932552</span> <span class="keyword">AND</span> `invisible` <span class="keyword">IN</span>(<span class="string">'0'</span>,<span class="string">'-2'</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> dateline <span class="keyword">DESC</span>  LIMIT <span class="number">10</span>;</div><div class="line">...</div><div class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>

<p>实验证明效果是极好的，其实不难理解，上面我们就说了in()在MySQL优化器里面是以多种组合方式来检索数据的，如果加了一个排序或者分组那势必只能在临时结果集上操作，也就是说索引里面即使包含了排序或者分组的字段依然是没用的。唯一不满的是MySQL优化器的选择依然不够靠谱。</p>
<p>总结下：<strong>在MySQL查询里面使用in()，除了要注意in()list的数量以及eq_range_index_dive_limit的值以外（具体见下），还要注意如果SQL包含排序/分组/去重等等就需要注意索引的使用</strong>。</p>
<h2 id="eq_range_index_dive_limit的说明">eq_range_index_dive_limit的说明</h2>
<p>还是上面的案例，为什么idx_1无法直接使用？需要使用hint强制只用这个索引呢？这里我们首先看下eq_range_index_dive_limit的值。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">root@localhost 22:38:05 [ultrax]&gt; show variables like <span class="emphasis">'eq_range_index_dive_limit'</span>;</div><div class="line"><span class="code">+---------------------------+</span>-------+</div><div class="line"><span class="header">| Variable_name             | Value |</span></div><div class="line">+---------------------------+-------+</div><div class="line"><span class="header">| eq_range_index_dive_limit | 2     | </span></div><div class="line">+---------------------------+-------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>

<p>根据我们上面说的这种情况<strong>0 &lt; eq_range_index_dive_limit &lt;= N使用index statistics</strong>，那么接下来我们用OPTIMIZER_TRACE来一看究竟。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">  <span class="string">"index"</span>: <span class="string">"displayorder"</span>,</div><div class="line">  <span class="string">"ranges"</span>: [</div><div class="line">    <span class="string">"7932552 &lt;= tid &lt;= 7932552 AND -2 &lt;= invisible &lt;= -2"</span>,</div><div class="line">    <span class="string">"7932552 &lt;= tid &lt;= 7932552 AND 0 &lt;= invisible &lt;= 0"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"index_dives_for_eq_ranges"</span>: <span class="literal">false</span>,</div><div class="line">  <span class="string">"rowid_ordered"</span>: <span class="literal">false</span>,</div><div class="line">  <span class="string">"using_mrr"</span>: <span class="literal">false</span>,</div><div class="line">  <span class="string">"index_only"</span>: <span class="literal">false</span>,</div><div class="line">  <span class="string">"rows"</span>: <span class="number">54</span>,</div><div class="line">  <span class="string">"cost"</span>: <span class="number">66.81</span>,</div><div class="line">  <span class="string">"chosen"</span>: <span class="literal">true</span></div><div class="line">}</div><div class="line">// index dive为<span class="literal">false</span>，最终chosen是<span class="literal">true</span></div><div class="line">...</div><div class="line">{</div><div class="line">  <span class="string">"index"</span>: <span class="string">"idx_1"</span>,</div><div class="line">  <span class="string">"ranges"</span>: [</div><div class="line">    <span class="string">"7932552 &lt;= tid &lt;= 7932552"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"index_dives_for_eq_ranges"</span>: <span class="literal">true</span>,</div><div class="line">  <span class="string">"rowid_ordered"</span>: <span class="literal">false</span>,</div><div class="line">  <span class="string">"using_mrr"</span>: <span class="literal">false</span>,</div><div class="line">  <span class="string">"index_only"</span>: <span class="literal">false</span>,</div><div class="line">  <span class="string">"rows"</span>: <span class="number">120646</span>,</div><div class="line">  <span class="string">"cost"</span>: <span class="number">144776</span>,</div><div class="line">  <span class="string">"chosen"</span>: <span class="literal">false</span>,</div><div class="line">  <span class="string">"cause"</span>: <span class="string">"cost"</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>我们可以看到displayorder索引的cost是66.81，而idx_1的cost是120646，而最终MySQL优化器选择了displayorder这条索引。那么如果我们把eq_range_index_dive_limit设置&gt;N是不是应该就会使用index dive计算方式，得到更准确的执行计划呢？</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">root@localhost 22:52:52 [ultrax]&gt; set  eq<span class="emphasis">_range_</span>index<span class="emphasis">_dive_</span>limit = 3;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">root@localhost 22:55:38 [ultrax]&gt; explain SELECT * FROM pre<span class="emphasis">_forum_</span>post WHERE tid=7932552 AND <span class="smartquote">`invisible` IN('</span>0',<span class="emphasis">'-2'</span>) ORDER BY dateline DESC  LIMIT 10;</div><div class="line"><span class="code">+----+</span>-------------<span class="code">+----------------+</span>------<span class="code">+-------------------------------------------+</span>-------<span class="code">+---------+</span>-------<span class="code">+--------+</span>-------------+</div><div class="line"><span class="header">| id | select_type | table          | type | possible_keys                             | key   | key_len | ref   | rows   | Extra       |</span></div><div class="line">+----+-------------+----------------+------+-------------------------------------------+-------+---------+-------+--------+-------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | pre_forum_post | ref  | PRIMARY,displayorder,first,mul_test,idx_1 | idx_1 | 3       | const | 120646 | Using where | </span></div><div class="line">+----+-------------+----------------+------+-------------------------------------------+-------+---------+-------+--------+-------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>

<p>optimize_trace结果如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">  <span class="string">"index"</span>: <span class="string">"displayorder"</span>,</div><div class="line">  <span class="string">"ranges"</span>: [</div><div class="line">    <span class="string">"7932552 &lt;= tid &lt;= 7932552 AND -2 &lt;= invisible &lt;= -2"</span>,</div><div class="line">    <span class="string">"7932552 &lt;= tid &lt;= 7932552 AND 0 &lt;= invisible &lt;= 0"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"index_dives_for_eq_ranges"</span>: true,</div><div class="line">  <span class="string">"rowid_ordered"</span>: false,</div><div class="line">  <span class="string">"using_mrr"</span>: false,</div><div class="line">  <span class="string">"index_only"</span>: false,</div><div class="line">  <span class="string">"rows"</span>: <span class="number">188193</span>,</div><div class="line">  <span class="string">"cost"</span>: <span class="number">225834</span>,</div><div class="line">  <span class="string">"chosen"</span>: true</div><div class="line">}</div><div class="line"><span class="keyword">...</span></div><div class="line">{</div><div class="line">  <span class="string">"index"</span>: <span class="string">"idx_1"</span>,</div><div class="line">  <span class="string">"ranges"</span>: [</div><div class="line">    <span class="string">"7932552 &lt;= tid &lt;= 7932552"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"index_dives_for_eq_ranges"</span>: true,</div><div class="line">  <span class="string">"rowid_ordered"</span>: false,</div><div class="line">  <span class="string">"using_mrr"</span>: false,</div><div class="line">  <span class="string">"index_only"</span>: false,</div><div class="line">  <span class="string">"rows"</span>: <span class="number">120646</span>,</div><div class="line">  <span class="string">"cost"</span>: <span class="number">144776</span>,</div><div class="line">  <span class="string">"chosen"</span>: true</div><div class="line">}</div><div class="line"><span class="keyword">...</span></div><div class="line">  <span class="string">"cost_for_plan"</span>: <span class="number">144775</span>,</div><div class="line">  <span class="string">"rows_for_plan"</span>: <span class="number">120646</span>,</div><div class="line">  <span class="string">"chosen"</span>: true</div><div class="line">// 在备选索引选择中两条索引都被选择，在最后的逻辑优化中选在了代价最小的索引也就是idx_1</div></pre></td></tr></table></figure>

<p>以上就是在等值范围查询中eq_range_index_dive_limit的值怎么影响MySQL优化器计算开销，从而影响索引的选择。另外我们可以通过profiling来看看优化器的统计耗时：</p>
<p><strong>index dive</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">+----------------------+----------+</div><div class="line">| <span class="class">Status</span>               | <span class="class">Duration</span> |</div><div class="line">+----------------------+----------+</div><div class="line"><span class="localvars">| starting             |</span> <span class="number">0.000048</span> | </div><div class="line"><span class="localvars">| checking permissions |</span> <span class="number">0.000004</span> | </div><div class="line">| <span class="class">Opening</span> tables       | <span class="number">0.000015</span> | </div><div class="line"><span class="localvars">| init                 |</span> <span class="number">0.000044</span> | </div><div class="line">| <span class="class">System</span> lock          | <span class="number">0.000009</span> | </div><div class="line"><span class="localvars">| optimizing           |</span> <span class="number">0.000014</span> | </div><div class="line"><span class="localvars">| statistics           |</span> <span class="number">0.032089</span> | </div><div class="line"><span class="localvars">| preparing            |</span> <span class="number">0.000022</span> | </div><div class="line">| <span class="class">Sorting</span> result       | <span class="number">0.000003</span> | </div><div class="line"><span class="localvars">| executing            |</span> <span class="number">0.000003</span> | </div><div class="line">| <span class="class">Sending</span> data         | <span class="number">0.000101</span> | </div><div class="line"><span class="localvars">| end                  |</span> <span class="number">0.000004</span> | </div><div class="line"><span class="localvars">| query end            |</span> <span class="number">0.000002</span> | </div><div class="line"><span class="localvars">| closing tables       |</span> <span class="number">0.000009</span> | </div><div class="line"><span class="localvars">| freeing items        |</span> <span class="number">0.000013</span> | </div><div class="line"><span class="localvars">| cleaning up          |</span> <span class="number">0.000012</span> | </div><div class="line">+----------------------+----------+</div></pre></td></tr></table></figure>

<p><strong>index statistics</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">+----------------------+----------+</div><div class="line">| <span class="class">Status</span>               | <span class="class">Duration</span> |</div><div class="line">+----------------------+----------+</div><div class="line"><span class="localvars">| starting             |</span> <span class="number">0.000045</span> | </div><div class="line"><span class="localvars">| checking permissions |</span> <span class="number">0.000003</span> | </div><div class="line">| <span class="class">Opening</span> tables       | <span class="number">0.000014</span> | </div><div class="line"><span class="localvars">| init                 |</span> <span class="number">0.000040</span> | </div><div class="line">| <span class="class">System</span> lock          | <span class="number">0.000008</span> | </div><div class="line"><span class="localvars">| optimizing           |</span> <span class="number">0.000014</span> | </div><div class="line"><span class="localvars">| statistics           |</span> <span class="number">0.000086</span> | </div><div class="line"><span class="localvars">| preparing            |</span> <span class="number">0.000016</span> | </div><div class="line">| <span class="class">Sorting</span> result       | <span class="number">0.000002</span> | </div><div class="line"><span class="localvars">| executing            |</span> <span class="number">0.000002</span> | </div><div class="line">| <span class="class">Sending</span> data         | <span class="number">0.000016</span> | </div><div class="line">| <span class="class">Creating</span> sort index  | <span class="number">0.412123</span> | </div><div class="line"><span class="localvars">| end                  |</span> <span class="number">0.000012</span> | </div><div class="line"><span class="localvars">| query end            |</span> <span class="number">0.000004</span> | </div><div class="line"><span class="localvars">| closing tables       |</span> <span class="number">0.000013</span> | </div><div class="line"><span class="localvars">| freeing items        |</span> <span class="number">0.000023</span> | </div><div class="line"><span class="localvars">| cleaning up          |</span> <span class="number">0.000015</span> | </div><div class="line">+----------------------+----------+</div></pre></td></tr></table></figure>

<p>可以看到当eq_range_index_dive_limit加大使用index dive时，优化器统计耗时明显比ndex statistics方式来的长，但最终它使用了作出了更合理的执行计划。统计耗时0.032089s vs .000086s，但是SQL执行耗时却是约0.03s vs 0.41s。</p>
<h2 id="附：如何使用optimize_trace">附：如何使用optimize_trace</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="operator"><span class="keyword">set</span> optimizer_trace=<span class="string">'enabled=on'</span>;</span>  </div><div class="line"><span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> information_schema.optimizer_trace\G</span></div><div class="line">// 注：optimizer_trace建议只在<span class="keyword">session</span>模式下开启调试即可</div></pre></td></tr></table></figure>

<p><strong>参考资料</strong><br><a href="http://dev.mysql.com/doc/refman/5.6/en/range-optimization.html" target="_blank" rel="external">http://dev.mysql.com/doc/refman/5.6/en/range-optimization.html</a><br><a href="http://imysql.com/2014/08/05/a-fake-bug-with-eq-range-index-dive-limit.shtml" target="_blank" rel="external">http://imysql.com/2014/08/05/a-fake-bug-with-eq-range-index-dive-limit.shtml</a><br><a href="http://blog.163.com/li_hx/blog/static/18399141320147521735442/" target="_blank" rel="external">http://blog.163.com/li_hx/blog/static/18399141320147521735442/</a></p>

      
    </div>
    <footer class="article-footer">
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/09/25/separate-table/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">&lt;</strong>
      <div class="article-nav-title">
        
          [MySQL案例]之Discuz大表拆分
        
      </div>
    </a>
  
  
    <a href="/2014/09/22/recover-be-killed/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">[MySQL案例]之恢复进程莫名被杀</div>
      <strong class="article-nav-caption">&gt;</strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="in-and-range" data-title="[MySQL SQL优化系列]之in与range查询" data-url="http://myrock.github.io/2014/09/24/in-and-range/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"HiDBA"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
    		&copy; 2014 林晓嘉
    	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>

  <script src="/js/main.js" type="text/javascript"></script>


  </div>
</body>
</html>