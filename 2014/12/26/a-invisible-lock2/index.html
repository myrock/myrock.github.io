<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>[MySQL案例]之一把看不见的锁后续(metadata lock) | HiDBA | 林晓嘉</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="今天MySQL过载保护又立功干掉了一堆堵塞的SQL，到后台一看，发现了一大堆熟悉的”Waiting for table metadata lock”。之前刚好写过一篇关于metadata lock相关问题处理的文章，有兴趣的同学自己点进去看看。
关于metadata lock说明
在正式说明问题之前我们先来回顾下MySQL的metadata lock。metadata lock是MySQL在5.5">
<meta property="og:type" content="article">
<meta property="og:title" content="[MySQL案例]之一把看不见的锁后续(metadata lock)">
<meta property="og:url" content="http://myrock.github.io/2014/12/26/a-invisible-lock2/">
<meta property="og:site_name" content="HiDBA | 林晓嘉">
<meta property="og:description" content="今天MySQL过载保护又立功干掉了一堆堵塞的SQL，到后台一看，发现了一大堆熟悉的”Waiting for table metadata lock”。之前刚好写过一篇关于metadata lock相关问题处理的文章，有兴趣的同学自己点进去看看。
关于metadata lock说明
在正式说明问题之前我们先来回顾下MySQL的metadata lock。metadata lock是MySQL在5.5">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[MySQL案例]之一把看不见的锁后续(metadata lock)">
<meta name="twitter:description" content="今天MySQL过载保护又立功干掉了一堆堵塞的SQL，到后台一看，发现了一大堆熟悉的”Waiting for table metadata lock”。之前刚好写过一篇关于metadata lock相关问题处理的文章，有兴趣的同学自己点进去看看。
关于metadata lock说明
在正式说明问题之前我们先来回顾下MySQL的metadata lock。metadata lock是MySQL在5.5">

  
    <link rel="alternative" href="/atom.xml" title="HiDBA | 林晓嘉" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
  
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F3693cef63e2b72be16ac8ddde570e37d' type='text/javascript'%3E%3C/script%3E"));
</script>

</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<div class="profilepic">
			<img src="http://image-myrock-github-io.qiniudn.com/head.jpg">
		</div>

		<hgroup>
		  <h1 class="header-author"><a href="/">林晓嘉</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Technology change our life.</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">HOME</a></li>
				        
							<li><a href="/archives">ARCHIVES</a></li>
				        
							<li><a href="/aboutme">ABOUT</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/myrock/myrock.github.io" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/u/1735228455" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud">
						<a href="/tags/MySQL/" style="font-size: 20.00px;">MySQL</a><a href="/tags/NoSQL/" style="font-size: 13.33px;">NoSQL</a><a href="/tags/Redis/" style="font-size: 13.33px;">Redis</a><a href="/tags/SQL优化/" style="font-size: 16.67px;">SQL优化</a><a href="/tags/database/" style="font-size: 20.00px;">database</a><a href="/tags/ops/" style="font-size: 13.33px;">ops</a><a href="/tags/other/" style="font-size: 10.00px;">other</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://imysql.com/">叶金荣</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://ljf.me/">李健富</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://17173ops.com/">17173系统部</a>
			        
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					围绕着MySQL、NoSQL、Hadoop、运维开发领域摸爬滚打中的Rockpapa
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay"></div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="http://image-myrock-github-io.qiniudn.com/head.jpg">
			</div>

			<hgroup>
			  <h1 class="header-author"><a href="/">林晓嘉</a></h1>
			</hgroup>
			
			<p class="header-subtitle">Technology change our life.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">HOME</a></li>
		        
					<li><a href="/archives">ARCHIVES</a></li>
		        
					<li><a href="/aboutme">ABOUT</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/myrock/myrock.github.io" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/u/1735228455" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <article id="post-a-invisible-lock2" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/12/26/a-invisible-lock2/" class="article-date">
  	<time datetime="2014-12-26T13:19:37.000Z" itemprop="datePublished">12月 26 2014</time>
</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/database/">database</a></li></ul>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      [MySQL案例]之一把看不见的锁后续(metadata lock)
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天MySQL过载保护又立功干掉了一堆堵塞的SQL，到后台一看，发现了一大堆熟悉的”Waiting for table metadata lock”。之前刚好写过一篇关于metadata lock相关问题处理的<a href="http://myrock.github.io/2014/09/20/a-invisible-lock/" target="_blank" rel="external">文章</a>，有兴趣的同学自己点进去看看。</p>
<h2 id="关于metadata_lock说明">关于metadata lock说明</h2>
<p>在正式说明问题之前我们先来回顾下MySQL的metadata lock。metadata lock是MySQL在5.5.3版本以后引入的，在那之前MySQL的元数据锁的颗粒度是statement级别，在5.5.3版本引入metadata lock以后变成是transaction级别，改造的目的是为了解决著名的BUG989，也就是说可能出现slave同步复制失败。简单来说就是因为MySQL二进制日志是顺序写，如果在事务未提交前执行了DDL，则二进制日志先记录了DDL再记录DML的语句就可能导致slave同步应用失败。具体参见<a href="http://bugs.mysql.com/bug.php?id=989" target="_blank" rel="external">MySQL BUG989</a>。关于metadata lock的说明可以看<a href="http://dev.mysql.com/doc/refman/5.5/en/metadata-locking.html" target="_blank" rel="external">这里</a>。</p>
<a id="more"></a>

<h2 id="问题说在前面">问题说在前面</h2>
<p>这次发现大量的SELECT执行超过300秒，状态都是”Waiting for table metadata lock”。按照前面的说明，metadata lock应该是与DDL加锁互斥，而DDL加的是一把write access read lock，理论上是不会堵塞查询请求。而后在测试过程中又遇到几个问题，这里就一一描述下：</p>
<p><strong>问题一：为什么出现上文提及的select会需要等待metadata lock加锁？</strong><br><strong>问题二：在测试过程中发现模拟同样的操作，有些select无需等待metadata lock加锁？</strong><br><strong>问题三：为什么有些DDL不会有metadata lock等待？同样的数据表在5.5与5.6版本下实验结果不一致？</strong></p>
<h2 id="问题一过程重现">问题一过程重现</h2>
<p>这个就是这次发生的问题，这里做个简答的现场重现</p>
<p><em>session A</em> //开启显性事务，执行一个查询后不要提交</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mysql&gt; begin;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line"><span class="header">mysql&gt; select * from a;</span></div><div class="line">+------+</div><div class="line"><span class="header">| id   |</span></div><div class="line">+------+</div><div class="line"><span class="header">|    1 | </span></div><div class="line">+------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>

<p><em>session B</em> //执行一个DDL</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; alter table a add id2 int;</div><div class="line"><span class="keyword">...</span>堵塞中</div></pre></td></tr></table></figure>

<p><em>session C</em> //执行一个查询</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select * from a;</div><div class="line"><span class="keyword">...</span>堵塞中</div></pre></td></tr></table></figure>

<p><em>session D</em> //查看进程状态</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="header">mysql&gt; show processlist;</span></div><div class="line">+-----+------+-----------+--------------+---------+------+---------------------------------+---------------------------+-----------+---------------+-----------+</div><div class="line"><span class="header">| Id  | User | Host      | db           | Command | Time | State                           | Info                      | Rows_sent | Rows_examined | Rows_read |</span></div><div class="line">+-----+------+-----------+--------------+---------+------+---------------------------------+---------------------------+-----------+---------------+-----------+</div><div class="line">| 181 | root | localhost | join<span class="emphasis">_test_</span>db | Sleep   |  169 |                                 | NULL                      |         1 |             1 |         2 | </div><div class="line">| 182 | root | localhost | join<span class="emphasis">_test_</span>db | Query   |   96 | Waiting for table metadata lock | alter table a add id2 int |         0 |             0 |         2 | </div><div class="line">| 184 | root | localhost | join<span class="emphasis">_test_</span>db | Query   |   50 | Waiting for table metadata lock | select * from a           |         0 |             0 |         1 | </div><div class="line"><span class="header">| 185 | root | localhost | join_test_db | Query   |    0 | NULL                            | show processlist          |         0 |             0 |         5 | </span></div><div class="line">+-----+------+-----------+--------------+---------+------+---------------------------------+---------------------------+-----------+---------------+-----------+</div><div class="line">4 rows in set (0.00 sec)</div></pre></td></tr></table></figure>

<p>然后session A提交以后，session B跟session C就都解锁开始执行。</p>
<h2 id="问题二过程重现">问题二过程重现</h2>
<p><em>session A</em> //开启显性事务，执行一个查询后不要提交</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mysql&gt; begin;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line"><span class="header">mysql&gt; select * from a;</span></div><div class="line">+------+------+</div><div class="line"><span class="header">| id   | id2  |</span></div><div class="line">+------+------+</div><div class="line"><span class="header">|    1 | NULL | </span></div><div class="line">+------+------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>

<p><em>session B</em> //执行一个DDL</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; alter table a add id3 int;</div><div class="line"><span class="keyword">...</span>堵塞中</div></pre></td></tr></table></figure>

<p><em>session C</em> //执行一个查询</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="header">mysql&gt; mysql&gt; select * from a;          </span></div><div class="line">+------+------+</div><div class="line"><span class="header">| id   | id2  |</span></div><div class="line">+------+------+</div><div class="line"><span class="header">|    1 | NULL | </span></div><div class="line">+------+------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>

<p><em>session D</em> //查看进程状态</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="header">mysql&gt; show processlist;</span></div><div class="line">+-----+------+-----------+--------------+---------+------+---------------------------------+---------------------------+-----------+---------------+-----------+</div><div class="line"><span class="header">| Id  | User | Host      | db           | Command | Time | State                           | Info                      | Rows_sent | Rows_examined | Rows_read |</span></div><div class="line">+-----+------+-----------+--------------+---------+------+---------------------------------+---------------------------+-----------+---------------+-----------+</div><div class="line">| 181 | root | localhost | join<span class="emphasis">_test_</span>db | Sleep   |   15 |                                 | NULL                      |         1 |             1 |         2 | </div><div class="line">| 182 | root | localhost | join<span class="emphasis">_test_</span>db | Query   |   11 | Waiting for table metadata lock | alter table a add id3 int |         0 |             0 |         2 | </div><div class="line">| 184 | root | localhost | join<span class="emphasis">_test_</span>db | Sleep   |    7 |                                 | NULL                      |         0 |             0 |         2 | </div><div class="line"><span class="header">| 185 | root | localhost | join_test_db | Query   |    0 | NULL                            | show processlist          |         0 |             0 |         5 | </span></div><div class="line">+-----+------+-----------+--------------+---------+------+---------------------------------+---------------------------+-----------+---------------+-----------+</div><div class="line">4 rows in set (0.00 sec)</div></pre></td></tr></table></figure>

<p>然后session A提交以后，session B就解锁开始执行。</p>
<h2 id="问题三过程重现">问题三过程重现</h2>
<p>第三个问题是在一张<strong>两千万的大表</strong>上测试发现的，在测试的过程中发现DDL的状态并未处于”Waiting for table metadata lock”，而是开始执行，在查看进程的时候已经是处于”copy to tmp table”状态。<br>更奇怪的是同样的数据在不同版本的数据库中，实验结果是不一样的。在5.5.28的版本中如上面描述的未出现”Waiting for table metadata lock”，但是在5.6.21版本实验的结果是跟问题一描述得有一般。</p>
<p><strong>MySQL5.5.28实验</strong></p>
<p><em>session A</em> //开启显性事务，执行一个查询后不要提交</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mysql&gt; begin;         </div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line"><span class="header">mysql&gt; select * from t_user_log limit 1 ;</span></div><div class="line">+----+-----------+----------------------+--------------+-----------------+-----------------------------------+------------+-----------+-----------+</div><div class="line"><span class="header">| id | uid       | username             | appname      | loginip         | loginlocation                     | logintime  | logintype | useragent |</span></div><div class="line">+----+-----------+----------------------+--------------+-----------------+-----------------------------------+------------+-----------+-----------+</div><div class="line"><span class="header">|  1 | 101603700 | xxxxxx@17173.com     | 发号中心     | xx.246.216.xxx  | 湖南省郴州市 (永兴)电信           | 1406822402 |         1 |           | </span></div><div class="line">+----+-----------+----------------------+--------------+-----------------+-----------------------------------+------------+-----------+-----------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>

<p><em>session B</em> //执行一个DDL</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">mysql&gt;</span> alter table t_user_log add xxx int;</span></div></pre></td></tr></table></figure>

<p><em>session C</em> //执行一个查询</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="header">mysql&gt; select * from t_user_log limit 1 ;</span></div><div class="line">+----+-----------+----------------------+--------------+-----------------+-----------------------------------+------------+-----------+-----------+</div><div class="line"><span class="header">| id | uid       | username             | appname      | loginip         | loginlocation                     | logintime  | logintype | useragent |</span></div><div class="line">+----+-----------+----------------------+--------------+-----------------+-----------------------------------+------------+-----------+-----------+</div><div class="line"><span class="header">|  1 | 101603700 | xxxxxx@17173.com     | 发号中心     | xx.246.216.xxx  | 湖南省郴州市 (永兴)电信           | 1406822402 |         1 |           | </span></div><div class="line">+----+-----------+----------------------+--------------+-----------------+-----------------------------------+------------+-----------+-----------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>

<p><em>session D</em> //查看进程状态</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show processlist;</div><div class="line">+-----+------+-----------+--------------+---------+------+-------------------+------------------------------------+-----------+---------------+-----------+</div><div class="line">| <span class="class">Id</span>  | <span class="class">User</span> | <span class="class">Host</span>      <span class="localvars">| db           |</span> <span class="class">Command</span> | <span class="class">Time</span> | <span class="class">State</span>             | <span class="class">Info</span>                               | <span class="class">Rows_sent</span> | <span class="class">Rows_examined</span> | <span class="class">Rows_read</span> |</div><div class="line">+-----+------+-----------+--------------+---------+------+-------------------+------------------------------------+-----------+---------------+-----------+</div><div class="line">| <span class="number">181</span> <span class="localvars">| root | localhost | join_test_db |</span> <span class="class">Sleep</span>   |   <span class="number">28</span> |                   | <span class="class">NULL</span>                               |         <span class="number">1</span> |             <span class="number">1</span> |         <span class="number">2</span> | </div><div class="line">| <span class="number">182</span> <span class="localvars">| root | localhost | join_test_db |</span> <span class="class">Query</span>   |   <span class="number">15</span> <span class="localvars">| copy to tmp table | alter table t_user_log add xxx int |</span>         <span class="number">0</span> |             <span class="number">0</span> |    <span class="number">377166</span> | </div><div class="line">| <span class="number">184</span> <span class="localvars">| root | localhost | join_test_db |</span> <span class="class">Sleep</span>   |    <span class="number">5</span> |                   | <span class="class">NULL</span>                               |         <span class="number">1</span> |             <span class="number">1</span> |         <span class="number">2</span> | </div><div class="line">| <span class="number">185</span> <span class="localvars">| root | localhost | join_test_db |</span> <span class="class">Query</span>   |    <span class="number">0</span> | <span class="class">NULL</span>              <span class="localvars">| show processlist                   |</span>         <span class="number">0</span> |             <span class="number">0</span> |         <span class="number">5</span> | </div><div class="line">+-----+------+-----------+--------------+---------+------+-------------------+------------------------------------+-----------+---------------+-----------+</div><div class="line"><span class="number">4</span> rows in set (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>

<p><strong>MySQL5.6.21实验</strong></p>
<p><em>session A</em> //开启显性事务，执行一个查询后不要提交</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mysql&gt; begin;         </div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line"><span class="header">mysql&gt; select * from t_user_log limit 1 ;</span></div><div class="line">+----+-----------+----------------------+--------------+-----------------+-----------------------------------+------------+-----------+-----------+</div><div class="line"><span class="header">| id | uid       | username             | appname      | loginip         | loginlocation                     | logintime  | logintype | useragent |</span></div><div class="line">+----+-----------+----------------------+--------------+-----------------+-----------------------------------+------------+-----------+-----------+</div><div class="line"><span class="header">|  1 | 101603700 | xxxxxx@17173.com     | 发号中心     | xx.246.216.xxx  | 湖南省郴州市 (永兴)电信           | 1406822402 |         1 |           | </span></div><div class="line">+----+-----------+----------------------+--------------+-----------------+-----------------------------------+------------+-----------+-----------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>

<p><em>session B</em> //执行一个DDL</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; alter table t_user_log add xxx int;</div><div class="line"><span class="keyword">...</span>堵塞中</div></pre></td></tr></table></figure>

<p><em>session C</em> //执行一个查询</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select * from t_user_log limit <span class="number">1</span> ;</div><div class="line"><span class="keyword">...</span>堵塞中</div></pre></td></tr></table></figure>

<p><em>session D</em> //查看进程状态</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="header">mysql&gt; show processlist;</span></div><div class="line">+----+------+-----------+--------------+---------+------+---------------------------------+------------------------------------+</div><div class="line"><span class="header">| Id | User | Host      | db           | Command | Time | State                           | Info                               |</span></div><div class="line">+----+------+-----------+--------------+---------+------+---------------------------------+------------------------------------+</div><div class="line">| 38 | root | localhost | join<span class="emphasis">_test_</span>db | Sleep   |   18 |                                 | NULL                               | </div><div class="line">| 39 | root | localhost | join<span class="emphasis">_test_</span>db | Query   |   12 | Waiting for table metadata lock | alter table t<span class="emphasis">_user_</span>log add xxx int | </div><div class="line">| 40 | root | localhost | join<span class="emphasis">_test_</span>db | Query   |    5 | Waiting for table metadata lock | select * from t<span class="emphasis">_user_</span>log limit 1   | </div><div class="line"><span class="header">| 41 | root | localhost | join_test_db | Query   |    0 | init                            | show processlist                   | </span></div><div class="line">+----+------+-----------+--------------+---------+------+---------------------------------+------------------------------------+</div><div class="line">4 rows in set (0.00 sec)</div></pre></td></tr></table></figure>

<p>同样的实验在不同的数据库版本中结果居然是不一样的，这个又是为什么呢？</p>
<h2 id="问题一答案">问题一答案</h2>
<p>在第一个问题的实验中我们发现一个未提交的事务使得后续的DDL以及SELECT请求都堵塞了，一旦commit以后，后面的两个请求都能迅速执行，那么我们就来可以借助profile工具来看下到底两个请求分别是在什么地方发生了等待。</p>
<p><strong>session B</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show profile;</div><div class="line">+------------------------------+-----------+</div><div class="line">| <span class="class">Status</span>                       | <span class="class">Duration</span>  |</div><div class="line">+------------------------------+-----------+</div><div class="line"><span class="localvars">| starting                     |</span>  <span class="number">0.000046</span> | </div><div class="line"><span class="localvars">| checking permissions         |</span>  <span class="number">0.000004</span> | </div><div class="line"><span class="localvars">| checking permissions         |</span>  <span class="number">0.000004</span> | </div><div class="line"><span class="localvars">| init                         |</span>  <span class="number">0.000008</span> | </div><div class="line">| <span class="class">Opening</span> tables               |  <span class="number">0.000052</span> | </div><div class="line">| <span class="class">System</span> lock                  |  <span class="number">0.000009</span> | </div><div class="line"><span class="localvars">| setup                        |</span>  <span class="number">0.000020</span> | </div><div class="line"><span class="localvars">| creating table               |</span>  <span class="number">0.016214</span> | </div><div class="line">| <span class="class">After</span> create                 |  <span class="number">0.000051</span> | </div><div class="line"><span class="localvars">| copy to tmp table            |</span>  <span class="number">0.000165</span> | </div><div class="line"><span class="localvars">| rename result table          |</span> <span class="number">16.229622</span> | </div><div class="line"><span class="localvars">| end                          |</span>  <span class="number">0.000134</span> | </div><div class="line">| <span class="class">Waiting</span> for query cache lock |  <span class="number">0.000003</span> | </div><div class="line"><span class="localvars">| end                          |</span>  <span class="number">0.000013</span> | </div><div class="line"><span class="localvars">| query end                    |</span>  <span class="number">0.000003</span> | </div><div class="line"><span class="localvars">| closing tables               |</span>  <span class="number">0.000011</span> | </div><div class="line"><span class="localvars">| freeing items                |</span>  <span class="number">0.000017</span> | </div><div class="line"><span class="localvars">| cleaning up                  |</span>  <span class="number">0.000003</span> | </div><div class="line">+------------------------------+-----------+</div><div class="line"><span class="number">18</span> rows in set (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>

<p><strong>session C</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show profile;</div><div class="line">+--------------------------------+----------+</div><div class="line">| <span class="class">Status</span>                         | <span class="class">Duration</span> |</div><div class="line">+--------------------------------+----------+</div><div class="line"><span class="localvars">| starting                       |</span> <span class="number">0.000016</span> | </div><div class="line">| <span class="class">Waiting</span> for query cache lock   | <span class="number">0.000002</span> | </div><div class="line">| <span class="class">Waiting</span> on query cache mutex   | <span class="number">0.000002</span> | </div><div class="line"><span class="localvars">| checking query cache for query |</span> <span class="number">0.000033</span> | </div><div class="line"><span class="localvars">| checking permissions           |</span> <span class="number">0.000006</span> | </div><div class="line">| <span class="class">Opening</span> tables                 | <span class="number">8.808491</span> | </div><div class="line">| <span class="class">System</span> lock                    | <span class="number">0.000009</span> | </div><div class="line">| <span class="class">Waiting</span> for query cache lock   | <span class="number">0.000002</span> | </div><div class="line">| <span class="class">Waiting</span> on query cache mutex   | <span class="number">0.000017</span> | </div><div class="line"><span class="localvars">| init                           |</span> <span class="number">0.000016</span> | </div><div class="line"><span class="localvars">| optimizing                     |</span> <span class="number">0.000003</span> | </div><div class="line"><span class="localvars">| statistics                     |</span> <span class="number">0.000009</span> | </div><div class="line"><span class="localvars">| preparing                      |</span> <span class="number">0.000008</span> | </div><div class="line"><span class="localvars">| executing                      |</span> <span class="number">0.000002</span> | </div><div class="line">| <span class="class">Sending</span> data                   | <span class="number">0.000040</span> | </div><div class="line"><span class="localvars">| end                            |</span> <span class="number">0.000003</span> | </div><div class="line"><span class="localvars">| query end                      |</span> <span class="number">0.000003</span> | </div><div class="line"><span class="localvars">| closing tables                 |</span> <span class="number">0.000005</span> | </div><div class="line"><span class="localvars">| freeing items                  |</span> <span class="number">0.000005</span> | </div><div class="line">| <span class="class">Waiting</span> for query cache lock   | <span class="number">0.000002</span> | </div><div class="line">| <span class="class">Waiting</span> on query cache mutex   | <span class="number">0.000001</span> | </div><div class="line"><span class="localvars">| freeing items                  |</span> <span class="number">0.000008</span> | </div><div class="line">| <span class="class">Waiting</span> for query cache lock   | <span class="number">0.000001</span> | </div><div class="line">| <span class="class">Waiting</span> on query cache mutex   | <span class="number">0.000001</span> | </div><div class="line"><span class="localvars">| freeing items                  |</span> <span class="number">0.000002</span> | </div><div class="line"><span class="localvars">| storing result in query cache  |</span> <span class="number">0.000002</span> | </div><div class="line"><span class="localvars">| logging slow query             |</span> <span class="number">0.000001</span> | </div><div class="line"><span class="localvars">| cleaning up                    |</span> <span class="number">0.000002</span> | </div><div class="line">+--------------------------------+----------+</div><div class="line"><span class="number">28</span> rows in set (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>

<p>从上面profile的结果我们可以的只session B是在rename result table的时候发生等待，也就是说metadata lock确实堵塞了修改表结构的操作。<br>而session C先是检查query cache后发现没有命中，然后才在Opening tables的时候发生了等待，而实际上也就是说<strong>rename result table这个步骤堵塞了Opening tables的执行</strong>，这个也能理解，就像X与S互斥一样。（在MySQL 5.6的版本中profile输出略有不同，会在rename result table下面显示Waiting for table metadata lock的具体等待时间以及等待时长）<br>这样我们就发现了第一个问题的答案，那么第二个问题也不难发现，那就是session C执行SELECT过程中没有执行Opening tables步骤，也就是说直接在query cache中命中，下面我们继续验证。</p>
<h2 id="问题二答案">问题二答案</h2>
<p>我们继续看下问题二的session C的profile<br><strong>session C</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="header">mysql&gt; show profile;            </span></div><div class="line">+--------------------------------+----------+</div><div class="line"><span class="header">| Status                         | Duration |</span></div><div class="line">+--------------------------------+----------+</div><div class="line">| starting                       | 0.000015 | </div><div class="line">| Waiting for query cache lock   | 0.000002 | </div><div class="line">| Waiting on query cache mutex   | 0.000002 | </div><div class="line">| checking query cache for query | 0.000006 | </div><div class="line">| checking privileges on cached  | 0.000003 | </div><div class="line">| checking permissions           | 0.000007 | </div><div class="line">| sending cached result to clien | 0.000011 | </div><div class="line">| logging slow query             | 0.000002 | </div><div class="line"><span class="header">| cleaning up                    | 0.000001 | </span></div><div class="line">+--------------------------------+----------+</div><div class="line">9 rows in set (0.00 sec)</div></pre></td></tr></table></figure>

<p>结果不出意料之外，SELECT请求没有出现等待metadata lock的情况是因为query cache能够命中而无需执行Opening tables。</p>
<h2 id="问题三答案">问题三答案</h2>
<p>我们刚在问题三的MySQL 5.5.28实验中发现session B中的DDL请求并未处于”Waiting for table metadata lock”而是开始执行并处于”copy to tmp table”状态。但是经过前面两个问题的解析，我们就能明白其实并不是session B的DDL没有等待metadata lock加锁，而是加锁是在”rename result table”步骤，处于”copy to tmp table”之后，而前面我们也说了问题三的实验对象是一张<strong>两千万行的大表</strong>，所以临时表环境耗时很长，因此我们在show processlist的时候发现该进程处于”copy to tmp table”而不是”Waiting for table metadata lock”状态，造成了没有等待加锁的假象，其实继续等待下去，等待临时表生成完毕还是会进入等待加锁状态。</p>
<p>那为什么同样一张大表，在MySQL 5.6.21中却直接进入”Waiting for table metadata lock”呢？我们猜测跟MySQL 5.6的online DDL特性有关，下面我们还是通过profile来验证。</p>
<p><strong>session B</strong> </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show profile;                    </div><div class="line">+--------------------------------+----------+</div><div class="line">| <span class="class">Status</span>                         | <span class="class">Duration</span> |</div><div class="line">+--------------------------------+----------+</div><div class="line"><span class="localvars">| starting                       |</span> <span class="number">0.000065</span> | </div><div class="line"><span class="localvars">| checking permissions           |</span> <span class="number">0.000004</span> | </div><div class="line"><span class="localvars">| checking permissions           |</span> <span class="number">0.000005</span> | </div><div class="line"><span class="localvars">| init                           |</span> <span class="number">0.000003</span> | </div><div class="line">| <span class="class">Opening</span> tables                 | <span class="number">0.000035</span> | </div><div class="line"><span class="localvars">| setup                          |</span> <span class="number">0.000030</span> | </div><div class="line"><span class="localvars">| creating table                 |</span> <span class="number">0.000663</span> | </div><div class="line">| <span class="class">After</span> create                   | <span class="number">0.000078</span> | </div><div class="line">| <span class="class">Waiting</span> for table metadata loc | <span class="number">1.003192</span> | </div><div class="line">| <span class="class">After</span> create                   | <span class="number">0.000012</span> | </div><div class="line">| <span class="class">Waiting</span> for table metadata loc | <span class="number">1.002947</span> | </div><div class="line">| <span class="class">After</span> create                   | <span class="number">0.000014</span> | </div><div class="line">| <span class="class">Waiting</span> for table metadata loc | <span class="number">1.002883</span> | </div><div class="line">| <span class="class">After</span> create                   | <span class="number">0.000012</span> | </div><div class="line">| <span class="class">Waiting</span> for table metadata loc | <span class="number">1.002999</span> | </div><div class="line">| <span class="class">After</span> create                   | <span class="number">0.000012</span> | </div><div class="line">| <span class="class">Waiting</span> for table metadata loc | <span class="number">1.002944</span> | </div><div class="line">| <span class="class">After</span> create                   | <span class="number">0.000010</span> | </div><div class="line">| <span class="class">Waiting</span> for table metadata loc | <span class="number">1.002934</span> | </div><div class="line">| <span class="class">After</span> create                   | <span class="number">0.000008</span> | </div><div class="line">| <span class="class">Waiting</span> for table metadata loc | <span class="number">1.002937</span> | </div><div class="line">| <span class="class">After</span> create                   | <span class="number">0.000009</span> | </div><div class="line">| <span class="class">Waiting</span> for table metadata loc | <span class="number">1.002954</span> | </div><div class="line">| <span class="class">After</span> create                   | <span class="number">0.000009</span> | </div><div class="line">| <span class="class">Waiting</span> for table metadata loc | <span class="number">0.247139</span> | </div><div class="line">| <span class="class">After</span> create                   | <span class="number">0.000021</span> | </div><div class="line">| <span class="class">System</span> lock                    | <span class="number">0.000015</span> | </div><div class="line"><span class="localvars">| preparing for alter table      |</span> <span class="number">0.001604</span> | </div><div class="line"><span class="localvars">| altering table                 |</span> <span class="number">0.785378</span> | </div><div class="line"><span class="localvars">| committing alter table to stor |</span> <span class="number">0.032014</span> | </div><div class="line"><span class="localvars">| end                            |</span> <span class="number">0.000025</span> | </div><div class="line"><span class="localvars">| query end                      |</span> <span class="number">0.000154</span> | </div><div class="line"><span class="localvars">| closing tables                 |</span> <span class="number">0.000010</span> | </div><div class="line"><span class="localvars">| freeing items                  |</span> <span class="number">0.000017</span> | </div><div class="line"><span class="localvars">| cleaning up                    |</span> <span class="number">0.000018</span> | </div><div class="line">+--------------------------------+----------+</div><div class="line"><span class="number">35</span> rows in set, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>

<p>我们在profile中并未见”copy to tmp table”的步骤，这也就是为什么在一开始测试的5.6.21版本中不会像5.5.28版本那样需要在”copy to tmp table”等待那么久。下面我们关闭掉online DDL特性再来一试。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">mysql&gt; <span class="type">set</span> old_alter_table = <span class="number">1</span>;</div><div class="line"><span class="type">Query</span> <span class="type">OK</span>, <span class="number">0</span> rows affected (<span class="number">0</span>.<span class="number">00</span> sec)</div><div class="line"></div><div class="line">mysql&gt; alter table xxx add xxxid <span class="type">int</span>; //执行<span class="type">DDL</span></div><div class="line">...</div><div class="line"></div><div class="line">mysql&gt; show profile;                     </div><div class="line">+--------------------------------+----------+</div><div class="line">| <span class="type">Status</span>                         | <span class="type">Duration</span> |</div><div class="line">+--------------------------------+----------+</div><div class="line">| starting                       | <span class="number">0</span>.<span class="number">000055</span> | </div><div class="line">| checking permissions           | <span class="number">0</span>.<span class="number">000005</span> | </div><div class="line">| checking permissions           | <span class="number">0</span>.<span class="number">000004</span> | </div><div class="line">| init                           | <span class="number">0</span>.<span class="number">000002</span> | </div><div class="line">| <span class="type">Opening</span> tables                 | <span class="number">0</span>.<span class="number">000034</span> | </div><div class="line">| setup                          | <span class="number">0</span>.<span class="number">000035</span> | </div><div class="line">| creating table                 | <span class="number">0</span>.<span class="number">000558</span> | </div><div class="line">| <span class="type">After</span> create                   | <span class="number">0</span>.<span class="number">000020</span> | </div><div class="line">| <span class="type">System</span> lock                    | <span class="number">0</span>.<span class="number">002289</span> | </div><div class="line">| copy to tmp table              | <span class="number">1</span>.<span class="number">039543</span> | </div><div class="line">| rename <span class="literal">result</span> table            | <span class="number">0</span>.<span class="number">000017</span> | </div><div class="line">| <span class="type">Waiting</span> <span class="keyword">for</span> table metadata loc | <span class="number">1</span>.<span class="number">002122</span> | </div><div class="line">| rename <span class="literal">result</span> table            | <span class="number">0</span>.<span class="number">000012</span> | </div><div class="line">| <span class="type">Waiting</span> <span class="keyword">for</span> table metadata loc | <span class="number">1</span>.<span class="number">001946</span> | </div><div class="line">| rename <span class="literal">result</span> table            | <span class="number">0</span>.<span class="number">000009</span> | </div><div class="line">| <span class="type">Waiting</span> <span class="keyword">for</span> table metadata loc | <span class="number">1</span>.<span class="number">001933</span> | </div><div class="line">| rename <span class="literal">result</span> table            | <span class="number">0</span>.<span class="number">000008</span> | </div><div class="line">| <span class="type">Waiting</span> <span class="keyword">for</span> table metadata loc | <span class="number">1</span>.<span class="number">001938</span> | </div><div class="line">| rename <span class="literal">result</span> table            | <span class="number">0</span>.<span class="number">000009</span> | </div><div class="line">| <span class="type">Waiting</span> <span class="keyword">for</span> table metadata loc | <span class="number">1</span>.<span class="number">001964</span> | </div><div class="line">| rename <span class="literal">result</span> table            | <span class="number">0</span>.<span class="number">000009</span> | </div><div class="line">| <span class="type">Waiting</span> <span class="keyword">for</span> table metadata loc | <span class="number">0</span>.<span class="number">586454</span> | </div><div class="line">| rename <span class="literal">result</span> table            | <span class="number">0</span>.<span class="number">003639</span> | </div><div class="line">| <span class="keyword">end</span>                            | <span class="number">0</span>.<span class="number">000019</span> | </div><div class="line">| query <span class="keyword">end</span>                      | <span class="number">0</span>.<span class="number">000135</span> | </div><div class="line">| closing tables                 | <span class="number">0</span>.<span class="number">000018</span> | </div><div class="line">| freeing items                  | <span class="number">0</span>.<span class="number">000019</span> | </div><div class="line">| cleaning up                    | <span class="number">0</span>.<span class="number">000028</span> | </div><div class="line">+--------------------------------+----------+</div><div class="line"><span class="number">28</span> rows <span class="keyword">in</span> <span class="type">set</span>, <span class="number">1</span> warning (<span class="number">0</span>.<span class="number">00</span> sec)</div></pre></td></tr></table></figure>

<p>果然”copy to tmp table”出现了，这次再MySQL 5.6.21版本的实验结果就跟之前在问题三的MySQL 5.5.28版本的实验结果是一致的了（上面profile的结果是一张1w行的小表，2000w的大表执行一次ddl等待时间太长了…）。</p>
<h2 id="结论重复">结论重复</h2>
<ol>
<li>在MySQL 5.5.3以后的版本中，未提交的事务一定会堵塞DDL请求（据说5.6.6以后的版本做了相关的优化，未做测试暂且不提）</li>
<li>DDL在等待metada lock的过程中肯定会堵塞后续的DML请求，也有可能堵塞后续的SELECT请求（需要看SELECT请求是否能够命中qcache）</li>
<li>怎么处理这种问题是老生常谈了，优化SQL避免出现大事务，请求结束立即执行commit关闭事务，千万千万不要把所有的请求甚至包括代码的逻辑处理都塞在一个事务里面去完成，否则一旦出现一个DDL那就是灾难的发生，很难想象这次要是没有过载保护，XX系统是不会直接宕机呢？</li>
</ol>

      
    </div>
    <footer class="article-footer">
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/01/13/reids-dev-norm/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">&lt;</strong>
      <div class="article-nav-title">
        
          Redis开发规范一二三
        
      </div>
    </a>
  
  
    <a href="/2014/11/20/mysql-waiting-for-table-flush/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">[MySQL案例]之备份与Waiting for table flush</div>
      <strong class="article-nav-caption">&gt;</strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="a-invisible-lock2" data-title="[MySQL案例]之一把看不见的锁后续(metadata lock)" data-url="http://myrock.github.io/2014/12/26/a-invisible-lock2/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"HiDBA"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
    		&copy; 2016 林晓嘉
    	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>

  <script src="/js/main.js" type="text/javascript"></script>


  </div>
</body>
</html>