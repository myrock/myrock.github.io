<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Tag: mysql | HiDBA | 林晓嘉</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="林晓嘉 | 博客 | 数据库 | DBA | mysql | bi | 大数据">
<meta property="og:type" content="website">
<meta property="og:title" content="HiDBA | 林晓嘉">
<meta property="og:url" content="http://myrock.github.io/tags/mysql/">
<meta property="og:site_name" content="HiDBA | 林晓嘉">
<meta property="og:description" content="林晓嘉 | 博客 | 数据库 | DBA | mysql | bi | 大数据">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HiDBA | 林晓嘉">
<meta name="twitter:description" content="林晓嘉 | 博客 | 数据库 | DBA | mysql | bi | 大数据">

  
    <link rel="alternative" href="/atom.xml" title="HiDBA | 林晓嘉" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<div class="profilepic">
			<img src="http://image-myrock-github-io.qiniudn.com/head.jpg">
		</div>

		<hgroup>
		  <h1 class="header-author"><a href="/">林晓嘉</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Technology change our life.</p>
		
		<nav class="header-menu">
			<ul>
			
				<li><a href="/">HOME</a></li>
	        
				<li><a href="/tags/database">DATABASE</a></li>
	        
				<li><a href="/tags/linux">LINUX</a></li>
	        
				<li><a href="/tags/other">Other Technology</a></li>
	        
				<li><a href="/tags/life">LIFE</a></li>
	        
			</ul>
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/myrock/myrock.github.io" title="github">github</a>
		        
					<a class="weibo" target="_blank" href="http://weibo.com/u/1735228455" title="weibo">weibo</a>
		        
			</div>
		</nav>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay"></div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="http://image-myrock-github-io.qiniudn.com/head.jpg">
			</div>

			<hgroup>
			  <h1 class="header-author"><a href="/">林晓嘉</a></h1>
			</hgroup>
			
			<p class="header-subtitle">Technology change our life.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">HOME</a></li>
		        
					<li><a href="/tags/database">DATABASE</a></li>
		        
					<li><a href="/tags/linux">LINUX</a></li>
		        
					<li><a href="/tags/other">Other Technology</a></li>
		        
					<li><a href="/tags/life">LIFE</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/myrock/myrock.github.io" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/u/1735228455" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      
  
    <article id="post-[MySQL案例]之恢复进程莫名被杀" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/09/22/[MySQL案例]之恢复进程莫名被杀/" class="article-date">
  	<time datetime="2014-09-22T03:23:12.000Z" itemprop="datePublished">9月 22 2014</time>
</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/database/">database</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li></ul>

    </div>
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/09/22/[MySQL案例]之恢复进程莫名被杀/">[MySQL案例]之恢复进程莫名被杀</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天上班就发现一起数据库例行恢复作业失败，失败提示为：“数据库恢复失败”，也就是说是在执行mysql &lt; dumpfile的时候失败了。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[ root@localhost ]#<span class="regexp">/usr/</span>local<span class="regexp">/mysql56/</span>bin<span class="regexp">/mysql -S ./m</span>ysql.sock bi_monitor &lt; <span class="regexp">/home/m</span>ysql<span class="regexp">/backup/</span><span class="number">2014</span>-<span class="number">09</span>-<span class="number">21</span>_bi_monitor_3346.sql </div><div class="line">ERROR <span class="number">2006</span> (HY000) at line <span class="number">294</span>: MySQL server has gone away</div></pre></td></tr></table></figure>

<p>MySQL server has gone away是指客户端与MySQL服务端之间的连接段开，一般来说原因有这么几个：</p>
<ol>
<li>MySQL crash：MySQL Server宕机</li>
<li>connection timeout：客户端连接超时</li>
<li>kill connection：连接进程被杀，与connection timeout差不多，区别在于一个是MySQL Server主动，一个是被动</li>
<li>max_allowed_packet too small：返回结果集大于max_allowed_packet限制</li>
</ol>

        
          <p class="article-more-link">
            <a href="/2014/09/22/[MySQL案例]之恢复进程莫名被杀/#more">more >></a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      
      
    </footer>
  </div>
  
</article>






  
    <article id="post-[MySQL案例]之一把看不见的锁" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/09/20/[MySQL案例]之一把看不见的锁/" class="article-date">
  	<time datetime="2014-09-20T15:52:51.000Z" itemprop="datePublished">9月 20 2014</time>
</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/database/">database</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li></ul>

    </div>
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/09/20/[MySQL案例]之一把看不见的锁/">[MySQL案例]之一把看不见的锁</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>昨晚半夜处理了一个故障，只是简单SQL执行缺少索引导致CPU飙高，加一条索引就搞定。原来以为事情到此为止，让另外一个同事收尾准备睡觉了，这个时候高潮出现了。刚才处理的是一台slave server，为了保证实例数据对象一致性，让同事先删掉，然后在master server再加这条索引，最后发现add index的操作在slave server一直在等metadata lock释放了，并且在processlist里面居然找不到任何引起表锁的请求。就这样折腾了到凌晨，后面索性就丢在自己等锁释放，差不多过了6分钟创建成功，load再次下降。</p>
<h3 id="分析">分析</h3>
<p>事后在5.5的手册中找到了解释：</p>
<blockquote>
<p>To ensure transaction serializability, the server must not permit one session to perform a data definition language (DDL) statement on a table that is used in an uncompleted transaction in another session. The server achieves this by acquiring metadata locks on tables used within a transaction and deferring release of those locks until the transaction ends. A metadata lock on a table prevents changes to the table’s structure. This locking approach has the implication that a table that is being used by a transaction within one session cannot be used in DDL statements by other sessions until the transaction ends. </p>
</blockquote>

        
          <p class="article-more-link">
            <a href="/2014/09/20/[MySQL案例]之一把看不见的锁/#more">more >></a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      
      
    </footer>
  </div>
  
</article>






  
  

      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-right">
    		&copy; 2014 林晓嘉
    	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


  </div>
</body>
</html>